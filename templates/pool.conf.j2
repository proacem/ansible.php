; {{ ansible_managed }}

[global]
;pid = /home/sites/SITE_NAME/run/php-fpm.pid
;error_log = /home/sites/SITE_NAME/pub/log/php-fpm.log
;log_level = notice
emergency_restart_threshold = 10
emergency_restart_interval = 1m
process_control_timeout = 10s

[{{ item.site }}]

;prefix = /home/sites/SITE_NAME
security.limit_extensions = .php
;user = {{ item.site | default('www-data') }}
user = www-data
group = www-data
rlimit_files = 131072
rlimit_core = unlimited

listen =  {{ php_pool_listen }}/{{ item.site }}.sock
listen.allowed_clients = 127.0.0.1
;listen.owner = {{ item.site | default('www-data') }}
listen.owner = www-data
listen.group = www-data
listen.mode = 0660
listen.backlog = 65535

; The number of child processes to be created when pm is set to static
; and the maximum number of child processes to be created when pm is set to dynamic.
;
; Calculation MaxChildren:
; x MB RAM - y MB for OS and other than PHP = z MB Usable for PHP
; Each PHP process uses in average n MB RAM / z MB = children count - ~10 reserve for unforseen
pm.max_children = 32

; The number of requests each child process should execute before respawning. This can be useful to work around memory leaks in 3rd party libraries.
pm.max_requests = 1000

; ----------------------------------------------- default: low memory usage
; spawn processes on demand (slower)
pm = ondemand
pm.process_idle_timeout = 15s

; ----------------------------------------------- custom: higher performance
; pre spawn processes
;pm = dynamic
; The number of child processes created on startup. Used only when pm is set to dynamic.
;pm.start_servers = 5
; The desired minimum/maximum number of idle server processes. Used only when pm is set to dynamic.
;pm.min_spare_servers = 5
;pm.max_spare_servers = 16

;pm = dynamic
;pm.max_children = 5
;pm.start_servers = 3
;pm.min_spare_servers = 2
;pm.max_spare_servers = 4
;pm.max_requests = 200

pm.status_path = /php-fpm-status
ping.path = /php-fpm-ping
ping.response = pong

;slowlog = /home/sites/SITE_NAME/pub/log/php-fpm-slow.log
;request_slowlog_timeout = 5s
request_terminate_timeout = 180s
catch_workers_output = yes

;env[HOSTNAME] = $HOSTNAME
;env[PATH] = /usr/local/bin:/usr/bin:/bin
;env[TMP] = /home/sites/SITE_NAME/pub/tmp
;env[TMPDIR] = /home/sites/SITE_NAME/pub/tmp
;env[TEMP] = /home/sites/SITE_NAME/pub/tmp
